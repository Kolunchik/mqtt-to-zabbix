# mqtt-to-zabbix
Простой шаблон для связи WirenBoard и Zabbix, с применением LLD и макросов

Шаблон предназначен для простой и быстрой настройки мониторинга множества датчиков, подключенных к устройствам WirenBoard или любым другим, которые придерживаются подобной схемы названий топиков в mqtt.

В основном используются штатные шаблоны от WirenBoard. В папке wb-homa-modbus-templates лежат шаблоны для устройств, не имеющих штатных шаблонов - их нужно, при необходимости, положить в /usr/share/wb-homa-modbus/templates/.

*.xml файлы предназначены для импорта в Zabbix (нужна версия не ниже 3.4)
В файле zbx_export_templates.xml лежит сам шаблон.
В файле zbx_export_valuemaps.xml лежат настройки отображения значений (value mapping).

В mqtt-dump-to-zabbix.pl реализация разбора дампа, получаемого на WirenBoard с помощью родного для этого устройства mqtt-get-dump, на perl (может пригодится для опытов или можно по крону каждую минуту дампить, парсить и отправлять - так тоже можно, работает хорошо).

Скрипт mqtt-to-zabbix.py использует пакет paho.mqtt.client и хорошо работает под Python 3 на сторонних машинах, подключаясь к mqtt-брокеру (штатному, прямо на WirenBoard или любому другому, например на агрегации - в этом случае можно поменять маску подписки для топиков, ключ --mqtt-topic).

Скрипт mqtt-to-zabbix-wb.py просто использует пакет mosquitto (paho.mqtt.client из прошлого), заранее установленный на все WirenBoard и отлично работает прямо на устройстве. Во всём остальном отличий нет.

Для отправки все скрипты используют вызов zabbix_sender. Как показала практика, это быстрее и проще.

При запуске с ключом --help скрипты покажут небольшую справку по ключам.

LLD запускается при запуске с ключом --lld. При этом скрипт подключается к брокеру на время --lld-duration (по умолчанию 15 секунд) и по истечению времени отправляет сформированные запросы. Пустой lld (если устройства удалены) получается путём запуска с ключом --lld-null <тип_устройства> (например --lld-null wb-w1).

По умолчанию скрипты начинают просто отправлять данные (нормальный рабочий режим).

Файл mqtt-to-zabbix.service - образец юнита для systemd.

Файлы to_wirenboard_crontab.txt и to_wirenboard_monit.txt содержат примеры запуска скриптов на устройствах WirenBoard.

Настройки порогов влажности и температуры, названий и входов датчиков осуществляются через макросы в шаблоне Zabbix и в макросах хоста. В шаблоне есть примеры.

Для удобства настройки действий (actions) в триггерах прописаны тэги (см. шаблон)
К примеру - для тэга "error", содержащего значение "rw" (ошибка чтения/записи при работе с датчиком, часто бывает ложной) можно создать событие, которое будет срабатывать если эта ошибка висит более 1 минуты (обычные ложные срабатывания не висят более 1-2 секунд). При этом наличие тэга позволяет исключить эти события из списка тех, которые требуют немедленной реакции.

Эта схема работает уже много лет на большой инсталляции и показала свою жизнеспособность.

Текущая версия поправлена для обхода особенностей нового виджета графиков.
